<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- MODIFICATION: Title updated -->
    <title>I Ate It All - Tally</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Load Google Font (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            width: 100%;
            height: 100%;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            /* Prevent text selection on buttons */
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        /* Animations */
        @keyframes buttonBounce {
            0% { transform: scale(1); }
            50% { transform: scale(0.92); }
            100% { transform: scale(1); }
        }
        @keyframes buttonPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            50% { box-shadow: 0 0 0 15px rgba(74, 222, 128, 0); }
        }
        @keyframes ripple {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            100% {
                transform: scale(4);
                opacity: 0;
            }
        }
        /* Gentle arrow float for the "Why is this important?" prompt */
        @keyframes arrowFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }
        /* Make tap feedback more obvious on mobile */
        .tap-btn:active {
            transform: scale(0.95);
            opacity: 0.9;
        }
        /* Enhanced button animations */
        .tap-btn {
            transition: all 150ms cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .tap-btn:hover {
            transform: translateY(-2px);
        }
        .tap-btn:active {
            animation: buttonBounce 300ms ease-out;
        }
        /* Smooth thermometer fill animation */
        #thermoFill {
            transition: height 400ms ease;
        }
        /* Helper to hide screens */
        .hidden {
            display: none;
        }
        /* Ensure all screen containers stretch to fill viewport */
        .screen {
            width: 100vw;
            height: 100vh;
            min-height: 100vh;
        }
        /* Slider styling */
        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 5px;
            background: linear-gradient(to right, #86efac, #10b981);
            outline: none;
            -webkit-appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #059669;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: all 150ms ease;
        }
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #059669;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: all 150ms ease;
        }
        input[type="range"]::-moz-range-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        /* Entire green section clickable */
        #tallyArea {
            cursor: pointer;
            transition: background-color 150ms ease;
        }
        #tallyArea:active {
            background-color: #16a34a;
        }
        /* Tally button with enhanced animation */
        #tallyButton {
            position: relative;
            overflow: hidden;
        }
        #tallyButton::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
        }
        #tallyButton.clicked::before {
            animation: ripple 600ms ease-out;
        }
        /* Button glow on hover */
        #tallyButton:hover {
            box-shadow: 0 0 30px rgba(134, 239, 172, 0.6);
        }
        /* Left/right default proportions (match provided mockup) */
        #leftSide { flex: 0 0 28%; max-width: 28%; }
        #tallyArea { flex: 1; }
        /* Make the +1 large, plain and centered (no circle) */
        #tallyButton {
            background: transparent !important;
            width: 60%;
            height: auto;
            border-radius: 0 !important;
            box-shadow: none !important;
            padding: 2.5rem 0 !important;
            font-size: 6.5rem !important;
            line-height: 1 !important;
            display: block;
            text-align: center;
            color: #ffffff !important;
        }
        /* ensure the clickable area is full height and visually similar to the mock */
    #tallyArea { min-height: 100%; }
    /* Styles for the Why prompt and filler content */
    /* Panel top stays centered above the footer: reserve footer height so +1 remains vertically centered */
    .panelTop { min-height: calc(100% - 72px); display: flex; align-items: center; justify-content: center; width: 100%; }
    .panelFooter { height: 72px; position: sticky; bottom: 0; display: flex; align-items: center; justify-content: center; width: 100%; background: linear-gradient(to top, rgba(16,185,129,0.06), transparent); }
    #whyPrompt { color: #ffffff; margin-top: 0.25rem; text-align: center; }
    #whyPrompt .whyTitle { font-weight: 600; font-size: 1.05rem; }
    /* Use an inline SVG chevron (non-emoji) and animate the SVG element */
    #whyArrow svg { width: 26px; height: 26px; display: block; margin: 6px auto 0; stroke: #ffffff; stroke-width: 2; fill: none; animation: arrowFloat 1.2s ease-in-out infinite; }
    #whyContent { color: rgba(255,255,255,0.95); line-height: 1.5; }
    /* Slight translucent background for readability on long text */
    #whyContent p { margin-bottom: 1rem; }
        /* Screen transition animations */
        .screen-enter {
            opacity: 0;
            transform: translateY(6vh) scale(0.995);
        }
        .screen-enter-active {
            transition: opacity 420ms cubic-bezier(.2,.9,.2,1), transform 420ms cubic-bezier(.2,.9,.2,1);
            opacity: 1;
            transform: none;
        }
        .screen-exit {
            opacity: 1;
            transform: none;
        }
        .screen-exit-active {
            transition: opacity 320ms ease, transform 320ms ease;
            opacity: 0;
            transform: translateY(-3vh) scale(0.995);
        }
    </style>
</head>
<body class="w-screen h-screen bg-gray-100">

    <!-- ====================================================== -->
    <!-- Screen: Splash / Welcome (shown first)               -->
    <!-- ====================================================== -->
    <div id="splashScreen" class="screen w-full h-full flex flex-col items-center justify-center p-8 bg-yellow-300">
        <div class="max-w-xl text-center px-6">
            <!-- NOTE: Place the attached tiger image beside this HTML file
                 and name it `tiger.png` (same directory) or update the src below. -->
            <img id="splashImage" src="https://resources.finalsite.net/images/f_auto,q_auto/v1588659246/aesacin/kmaphlbpb2mlj4c5qqux/Tiger.png" alt="AES Tigers" class="mx-auto w-64 h-64 object-contain rounded-full shadow-xl"/>
            <h1 class="mt-6 text-6xl font-extrabold text-black">I ate it all!</h1>
            <p class="mt-2 text-xl text-black/80">The AES food waste project</p>
            <button id="enterBtn" class="mt-8 px-8 py-4 bg-black text-white rounded-full text-2xl font-semibold tap-btn">Enter</button>
            <button id="adminBtn" class="mt-4 px-6 py-3 bg-white text-black rounded-full text-lg font-medium border border-black tap-btn">Admin</button>
        </div>
    </div>

    <!-- ====================================================== -->
    <!-- Screen: Admin (hidden until opened)                  -->
    <!-- ====================================================== -->
    <div id="adminScreen" class="hidden screen w-full h-full flex flex-col items-center justify-start p-8 bg-gray-50">
        <div class="w-full max-w-2xl bg-white rounded-lg shadow p-6">
            <h2 class="text-2xl font-bold mb-4">Admin Panel (no login)</h2>
            <div class="grid grid-cols-1 gap-4">
                <label class="flex flex-col">
                    <span class="text-sm text-gray-600">Set total clean plates</span>
                    <input id="adminScoreInput" type="number" class="mt-1 p-2 border rounded" placeholder="Enter integer value" />
                </label>

                <label class="flex flex-col">
                    <span class="text-sm text-gray-600">Set goal value</span>
                    <input id="adminGoalInput" type="number" class="mt-1 p-2 border rounded" placeholder="e.g. 1000" />
                </label>

                <label class="flex flex-col">
                    <span class="text-sm text-gray-600">Goal period</span>
                    <select id="adminGoalPeriod" class="mt-1 p-2 border rounded">
                        <option value="total">Total / All-time</option>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </label>

                <div class="flex gap-3 mt-2">
                    <button id="adminSaveBtn" class="px-4 py-2 bg-green-600 text-white rounded">Save</button>
                    <button id="adminBackBtn" class="px-4 py-2 bg-gray-300 text-black rounded">Back</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ====================================================== -->
    <!-- Screen: Main Tally Screen (hidden until splash dismissed) -->
    <!-- ====================================================== -->
    <div id="mainScreen" class="hidden screen w-full h-full flex flex-col bg-green-50">
        <!-- Top Bar with Back Button & Header -->
        <div class="flex items-center justify-between px-6 py-4 bg-green-100 shadow-sm">
            <button id="backBtn" class="tap-btn px-3 py-2 text-sm font-semibold text-green-700 bg-white rounded border border-green-300 hover:bg-green-50">
                ‚Üê Back
            </button>
            <div class="text-center flex-1">
                <h2 class="text-2xl font-bold text-green-800">üç¥ üóëÔ∏è Clean Plate Tally üçΩÔ∏è ü•Ñ</h2>
                <p class="text-sm text-green-600">Tap the button for every clean plate!</p>
            </div>
            <div class="w-12"></div> <!-- Spacer for centering -->
        </div>

        <!-- Main Content Area: Flex row that fills remaining space -->
        <div class="flex flex-1 overflow-hidden">
            <!-- Left Side: Score Display + Thermometer + Progress Info -->
            <div id="leftSide" class="flex flex-col items-center justify-center flex-1 px-8 py-6 bg-green-50 transition-all duration-300">
                <!-- Big Score Display -->
                <p class="text-sm text-gray-600 mb-2">Total:</p>
                <p id="scoreDisplay" class="text-8xl md:text-9xl font-extrabold text-green-600 leading-none">
                    0
                </p>

                <!-- Goal & Period Info -->
                <div class="mt-6 text-center">
                    <p class="text-sm text-gray-600">Goal: <span id="goalLabel" class="font-semibold">1000</span> plates</p>
                    <p id="goalPeriodLabel" class="text-xs text-gray-500">Period: total</p>
                </div>

                <!-- Thermometer Display -->
                <div class="mt-8 flex items-center gap-4">
                    <div id="thermometer" class="w-16 h-64 bg-white rounded-full border-2 border-gray-300 shadow-inner overflow-hidden relative flex-shrink-0">
                        <div id="thermoFill" class="absolute bottom-0 left-0 w-full bg-red-500" style="height:0%"></div>
                    </div>
                    <div class="text-center">
                        <p class="text-3xl md:text-4xl font-bold text-green-700" id="percentLabel">0%</p>
                        <p id="countLabel" class="text-xs md:text-sm text-gray-600 mt-1">0 / 1000</p>
                    </div>
                </div>
            </div>

            <!-- Right Side: The Big +1 Button (entire section clickable) -->
            <div id="tallyArea" class="flex flex-col items-center justify-start flex-1 px-6 py-0 bg-green-500 transition-all duration-300 overflow-auto">
                <!-- Panel top: reserves space so the +1 button stays vertically centered above the sticky footer -->
                <div class="panelTop w-full">
                    <div class="w-full flex items-center justify-center">
                        <button id="tallyButton" class="tap-btn text-white font-bold shadow-none transition-all duration-150 ease-in-out">
                            +1
                        </button>
                    </div>
                </div>

                <!-- Sticky footer prompt at the bottom of the panel that invites scrolling -->
                <div class="panelFooter w-full">
    <div id="whyPrompt" class="text-center cursor-pointer">
        
        <div class="inline-flex flex-col items-center border-2 border-green-700 rounded-lg p-2 bg-white/50 hover:bg-white/80 transition-colors">
            <span class="whyTitle font-bold text-green-900">Why is this important?</span>
            <span id="whyArrow" aria-hidden="true">
                <svg class="w-6 h-6 text-green-900" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </span>
        </div>
    </div>
</div>

<div id="whyContent" class="mt-4 px-4 pb-8 w-full">
    <p>I created this app to solve the issue of food waste in the AES community through a shared goal of clean plates in the Cafeterias, the Tigers's Den, and more. </p>
    <p class="mt-2">A portion is the amount of food you choose to eat at one time. Many people inadvertently consume food due to the power of habit rather than hunger, resulting in unnecessary waste.</p>
    <p class="mt-2 font-bold">Here are some Tips:</p>
    <ul class="list-disc pl-5 mt-2 space-y-1">
        <li>Take only a smaller portion. You can always take more later if you need more.</li>
        <li>Use the hunger check - How hungry am I on a scale of 1-10?</li>
        <li>Avoid being distracted by your phone so you can be mindful about how much you are taking</li>
        <li>Pause mid-meal to see if you are still hungry, if you can save the rest, and did you take so much that you know better for next time.</li>
        <li>Practice ‚Äúone plate only‚Äù policy - put everything you plan to eat to fit on one plate, and avoid going back for seconds until 10 minutes have passed since your first serving.</li>
    </ul>
</div>

        <!-- Removed slider control - layout is fixed to match mockup -->
    </div>


    <!-- ====================================================== -->
    <!-- JavaScript (MODIFICATION: Simplified)                  -->
    <!-- ====================================================== -->
    <script type="module">
        // --- 1. Import Firebase Services ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            onSnapshot, 
            setDoc,
            increment
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 2. Get Canvas Environment Variables ---
        
        // This is a special variable from the environment.
        // For local testing, we can give it a default value.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-local-app';
        
        // ---
        // --- üî• Your Firebase Config ---
        // ---
        // MODIFICATION: Reverted to the config from your screenshot,
        // as the one from the text snippet was causing an API key error.
        const firebaseConfig = {
            apiKey: "AIzaSyDQSkidBXFHXywsHNXvRGgHfkFBdk30xU",
            authDomain: "aesfoodwasteproject.firebaseapp.com",
            projectId: "aesfoodwasteproject",
            storageBucket: "aesfoodwasteproject.appspot.com",
            messagingSenderId: "168810765354",
            appId: "1:168810765354:web:ca9355290bfbf93c4ef753",
            measurementId: "G-C-F10B6JV2ZX"
        };
        // ---
        
        // We set this to null for local testing.
        const initialAuthToken = null; 

        // --- 3. Initialize Firebase ---
        let app, auth, db, tallyDocRef;
        let unsubscribeFromTally; // To stop listening when not needed

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // Define the path to our single tally document
            // Using the 'appId' ensures this is unique to your app.
            const tallyPath = `/artifacts/${appId}/public/data/tally/campaign`;
            tallyDocRef = doc(db, tallyPath);

        } catch (e) {
            console.error("Error initializing Firebase:", e);
            alert("Could not connect to the database. Check your `firebaseConfig` object.");
        }


        // --- 4. Get References to UI Elements ---
        const scoreDisplay = document.getElementById('scoreDisplay');
    const tallyButton = document.getElementById('tallyButton');
    const backBtn = document.getElementById('backBtn');
    const tallyArea = document.getElementById('tallyArea');
    const leftSide = document.getElementById('leftSide');
    // Splash elements
    const splashScreen = document.getElementById('splashScreen');
    const mainScreen = document.getElementById('mainScreen');
    const enterBtn = document.getElementById('enterBtn');
    const adminBtn = document.getElementById('adminBtn');
    // Admin screen elements
    const adminScreen = document.getElementById('adminScreen');
    const adminScoreInput = document.getElementById('adminScoreInput');
    const adminGoalInput = document.getElementById('adminGoalInput');
    const adminGoalPeriod = document.getElementById('adminGoalPeriod');
    const adminSaveBtn = document.getElementById('adminSaveBtn');
    const adminBackBtn = document.getElementById('adminBackBtn');
        // Thermometer elements & goal (UI-only)
    const thermoFill = document.getElementById('thermoFill');
    const percentLabel = document.getElementById('percentLabel');
    const countLabel = document.getElementById('countLabel');
    const goalLabel = document.getElementById('goalLabel');
    const goalPeriodLabel = document.getElementById('goalPeriodLabel');
    // dynamic goal/period (default)
    let GOAL = 1000; // default main goal
    let GOAL_PERIOD = 'total';
    if (goalLabel) goalLabel.textContent = GOAL;
        // helper to format period for display
        function formatPeriod(p) {
            if (!p) return 'All-time';
            const map = {
                total: 'All-time',
                daily: 'Daily',
                weekly: 'Weekly',
                monthly: 'Monthly',
                yearly: 'Yearly'
            };
            return map[p] || String(p);
        }
        if (goalPeriodLabel) goalPeriodLabel.textContent = `Period: ${formatPeriod(GOAL_PERIOD)}`;

        // Smooth screen switching helper
        function switchScreen(fromEl, toEl) {
            // durations should match the CSS transitions above
            const enterMs = 420;
            const exitMs = 320;
            if (toEl) {
                toEl.classList.remove('hidden');
                // ensure previous animation classes removed
                toEl.classList.remove('screen-exit', 'screen-exit-active', 'screen-enter', 'screen-enter-active');
                toEl.classList.add('screen-enter');
                // force a reflow so the transition runs
                void toEl.offsetWidth;
                toEl.classList.add('screen-enter-active');
                // cleanup after animation: remove both enter classes so it stays visible
                setTimeout(() => {
                    toEl.classList.remove('screen-enter', 'screen-enter-active');
                }, enterMs + 20);
            }
            if (fromEl) {
                fromEl.classList.add('screen-exit');
                // force reflow
                void fromEl.offsetWidth;
                fromEl.classList.add('screen-exit-active');
                setTimeout(() => {
                    fromEl.classList.remove('screen-exit', 'screen-exit-active');
                    fromEl.classList.add('hidden');
                }, exitMs + 20);
            }
        }

        // Splash -> Main navigation
        if (enterBtn) {
            enterBtn.addEventListener('click', () => {
                switchScreen(splashScreen, mainScreen);
            });
        }

        // Admin button: open the admin screen and pre-fill current values
        if (adminBtn) {
            adminBtn.addEventListener('click', () => {
                // animated switch from splash -> admin
                switchScreen(splashScreen, adminScreen);
                // pre-fill with current values
                try {
                    // Use currently-known GOAL and GOAL_PERIOD and score display
                    if (adminGoalInput) adminGoalInput.value = GOAL;
                    if (adminGoalPeriod) adminGoalPeriod.value = GOAL_PERIOD || 'total';
                    if (adminScoreInput) adminScoreInput.value = Number(scoreDisplay.textContent) || 0;
                } catch (e) {
                    console.warn('Admin prefill failed', e);
                }
            });
        }

        // Admin Back: return to splash (animated)
        if (adminBackBtn) {
            adminBackBtn.addEventListener('click', () => {
                switchScreen(adminScreen, splashScreen);
            });
        }

        // Main Screen Back: return to splash (animated)
        if (backBtn) {
            backBtn.addEventListener('click', () => {
                switchScreen(mainScreen, splashScreen);
            });
        }

        // Layout is fixed to match the mockup (no slider)

        // --- Make entire green section clickable ---
        if (tallyArea) {
            tallyArea.addEventListener('click', async () => {
                // Trigger animation
                tallyButton.classList.add('clicked');
                setTimeout(() => tallyButton.classList.remove('clicked'), 600);
                
                // Disable locally for 1s to prevent rapid clicking
                disableTallyTemporary(1000);
                try {
                    // Use Firestore's `increment` to safely add 1
                    await setDoc(tallyDocRef, {
                        score: increment(1)
                    }, { merge: true });
                } catch (error) {
                    console.error("Error incrementing score:", error);
                }
            });
        }

        // --- Enhanced button animations ---
        // Back button animation
        if (backBtn) {
            backBtn.addEventListener('mouseenter', () => {
                backBtn.style.transform = 'translateY(-2px)';
            });
            backBtn.addEventListener('mouseleave', () => {
                backBtn.style.transform = 'translateY(0)';
            });
        }

        // Admin buttons animation
        if (adminSaveBtn) {
            adminSaveBtn.classList.add('tap-btn');
            adminSaveBtn.style.transition = 'all 150ms cubic-bezier(0.34, 1.56, 0.64, 1)';
        }
        if (adminBackBtn) {
            adminBackBtn.classList.add('tap-btn');
            adminBackBtn.style.transition = 'all 150ms cubic-bezier(0.34, 1.56, 0.64, 1)';
        }

        // Enter button animation
        if (enterBtn) {
            enterBtn.classList.add('tap-btn');
            enterBtn.style.transition = 'all 150ms cubic-bezier(0.34, 1.56, 0.64, 1)';
        }

        // Admin button animation
        if (adminBtn) {
            adminBtn.classList.add('tap-btn');
            adminBtn.style.transition = 'all 150ms cubic-bezier(0.34, 1.56, 0.64, 1)';
        }

        // Admin Save: write custom score/goal/period to the same tally document
        if (adminSaveBtn) {
            adminSaveBtn.addEventListener('click', async () => {
                const scoreVal = adminScoreInput ? Number(adminScoreInput.value) : null;
                const goalVal = adminGoalInput ? Number(adminGoalInput.value) : null;
                const periodVal = adminGoalPeriod ? adminGoalPeriod.value : null;
                const updateObj = {};
                if (!isNaN(scoreVal) && scoreVal !== null) updateObj.score = scoreVal;
                if (!isNaN(goalVal) && goalVal !== null) updateObj.goal = goalVal;
                if (periodVal) updateObj.period = periodVal;
                try {
                    if (Object.keys(updateObj).length > 0) {
                        await setDoc(tallyDocRef, updateObj, { merge: true });
                    }
                    // Update local variables immediately for UI
                    if (typeof updateObj.goal !== 'undefined') {
                        GOAL = updateObj.goal;
                        if (goalLabel) goalLabel.textContent = GOAL;
                    }
                    if (typeof updateObj.period !== 'undefined') {
                        GOAL_PERIOD = updateObj.period;
                        if (goalPeriodLabel) goalPeriodLabel.textContent = GOAL_PERIOD;
                    }
                    if (typeof updateObj.score !== 'undefined') {
                        scoreDisplay.textContent = updateObj.score;
                    }
                    // After saving, keep admin screen open so admin can continue making changes
                } catch (e) {
                    console.error('Admin save error', e);
                    alert('Could not save admin changes. Check console for details.');
                }
            });
        }

        // Try to load an external `tiger.png` first; if not available,
        // replace the <img> with an inline SVG fallback so the splash has
        // an embedded image without requiring a separate file.
        (function tryLoadEmbeddedTiger() {
            const imgEl = document.getElementById('splashImage');
            if (!imgEl) return;
            // Test fetch for the remote file. If it 404s or errors, replace with inline SVG.
            const remoteTiger = 'https://resources.finalsite.net/images/f_auto,q_auto/v1588659246/aesacin/kmaphlbpb2mlj4c5qqux/Tiger.png';
            fetch(remoteTiger, { method: 'HEAD' }).then(resp => {
                if (!resp.ok) {
                    // Replace with inline SVG fallback
                    const wrapper = imgEl.parentElement;
                    if (!wrapper) return;
                    wrapper.removeChild(imgEl);
                    // Simple circular tiger-style badge SVG fallback (stylistic placeholder)
                    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                    svg.setAttribute('viewBox', '0 0 200 200');
                    svg.setAttribute('width', '256');
                    svg.setAttribute('height', '256');
                    svg.innerHTML = `
                        <defs>
                          <linearGradient id="g" x1="0" x2="0" y1="0" y2="1">
                            <stop offset="0%" stop-color="#FFD54F"/>
                            <stop offset="100%" stop-color="#FFC107"/>
                          </linearGradient>
                        </defs>
                        <circle cx="100" cy="100" r="96" fill="black" />
                        <circle cx="100" cy="100" r="82" fill="url(#g)" />
                        <text x="50%" y="54%" text-anchor="middle" font-size="22" font-family="Inter, Arial" font-weight="700" fill="black">AES</text>
                        <text x="50%" y="76%" text-anchor="middle" font-size="18" font-family="Inter, Arial" fill="black">TIGERS</text>
                    `;
                    svg.classList.add('mx-auto', 'shadow-xl');
                    wrapper.appendChild(svg);
                    console.info('tiger.png not found; using inline SVG fallback. If you want your exact logo embedded, I can insert it as a base64 data-URI into the HTML.')
                }
            }).catch(() => {
                // On network or CORS error also fallback to SVG
                const wrapper = imgEl.parentElement;
                if (!wrapper) return;
                wrapper.removeChild(imgEl);
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('viewBox', '0 0 200 200');
                svg.setAttribute('width', '256');
                svg.setAttribute('height', '256');
                svg.innerHTML = `
                    <defs>
                      <linearGradient id="g2" x1="0" x2="0" y1="0" y2="1">
                        <stop offset="0%" stop-color="#FFD54F"/>
                        <stop offset="100%" stop-color="#FFC107"/>
                      </linearGradient>
                    </defs>
                    <circle cx="100" cy="100" r="96" fill="black" />
                    <circle cx="100" cy="100" r="82" fill="url(#g2)" />
                    <text x="50%" y="54%" text-anchor="middle" font-size="22" font-family="Inter, Arial" font-weight="700" fill="black">AES</text>
                    <text x="50%" y="76%" text-anchor="middle" font-size="18" font-family="Inter, Arial" fill="black">TIGERS</text>
                `;
                svg.classList.add('mx-auto', 'shadow-xl');
                wrapper.appendChild(svg);
                console.info('tiger.png not accessible; using inline SVG fallback. To embed the exact logo, provide the image and I will insert it as a base64 data-URI.')
            });
        })();
        
        // --- 5. Firebase Authentication Logic ---

        // Sign in the public (anonymous) user
        async function authAnonymous() {
             try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // For local testing, we just sign in anonymously.
                    await signInAnonymously(auth);
                }
                console.log("Anonymous auth successful.");
            } catch (error) {
                console.error("Anonymous Auth Error:", error);
            }
        }

        // --- 6. Core Tally Logic (Firestore) ---

        // Function to start listening for real-time score updates
        function listenToTally() {
            // Stop any old listener
            if (unsubscribeFromTally) unsubscribeFromTally();

            // Create a new listener on our document
            unsubscribeFromTally = onSnapshot(tallyDocRef, (doc) => {
                let currentScore = 0;
                    if (doc.exists()) {
                        const data = doc.data();
                        // score
                        currentScore = data.score;
                        // If a goal was saved in the document, use it
                        if (typeof data.goal !== 'undefined' && data.goal !== null) {
                            GOAL = Number(data.goal) || GOAL;
                        }
                        // If a period was saved, use it
                        if (typeof data.period !== 'undefined' && data.period !== null) {
                            GOAL_PERIOD = data.period;
                        }
                    } else {
                    // If the document doesn't exist, create it.
                    // This is good for the very first time the app runs.
                    setDoc(tallyDocRef, { score: 0 });
                }
                // Update the UI
                scoreDisplay.textContent = currentScore;
                // Update thermometer (UI-only, based on existing tally value)
                try {
                    const numeric = Number(currentScore) || 0;
                    const pct = Math.max(0, Math.min(1, numeric / GOAL));
                    const pctDisplay = Math.round(pct * 100);
                    if (thermoFill) thermoFill.style.height = (pct * 100) + '%';
                    if (percentLabel) percentLabel.textContent = pctDisplay + '%';
                        if (countLabel) countLabel.textContent = `${numeric} / ${GOAL} (${formatPeriod(GOAL_PERIOD)})`;
                        if (goalLabel) goalLabel.textContent = GOAL;
                        if (goalPeriodLabel) goalPeriodLabel.textContent = `Period: ${formatPeriod(GOAL_PERIOD)}`;
                } catch (e) {
                    console.warn('Thermometer update error', e);
                }
            }, (error) => {
                console.error("Error listening to tally:", error);
                alert("Connection lost. Please refresh.");
            });
        }

        // Helper: temporarily disable the tally button and grey it out
        function disableTallyTemporary(ms = 1000) {
            if (!tallyButton) return;
            tallyButton.disabled = true;
            // Visual disabled styles: remove green, add gray + reduced opacity
            tallyButton.classList.remove('bg-green-500');
            tallyButton.classList.add('bg-gray-400', 'opacity-80', 'pointer-events-none');
            setTimeout(() => {
                tallyButton.disabled = false;
                tallyButton.classList.remove('bg-gray-400', 'opacity-80', 'pointer-events-none');
                tallyButton.classList.add('bg-green-500');
            }, ms);
        }

        // NOTE: Increment handled via #tallyArea click handler (covers whole right side)

        // --- 7. Initial App Start ---
        authAnonymous(); // Sign in anonymously
        listenToTally(); // Start listening for score updates

        // --- 8. autoscroll for main screen --- //
        
    document.addEventListener("DOMContentLoaded", function() {
        const promptBtn = document.getElementById('whyPrompt');
        const contentDiv = document.getElementById('whyContent');

        promptBtn.addEventListener('click', function() {
            // This scrolls the content into view smoothly
            contentDiv.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        });
    });
    document.addEventListener("DOMContentLoaded", function() {
        const promptBtn = document.getElementById('whyPrompt');
        const contentDiv = document.getElementById('whyContent');

        promptBtn.addEventListener('click', function(event) {
            // 1. Stop the event from propagating (bubbling) up to the 
            //    parent elements (the larger button behind it).
            event.stopPropagation(); 

            // 2. Scroll the content into view smoothly (your original action)
            contentDiv.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        });
    });
    </script>
</body>
</html>
